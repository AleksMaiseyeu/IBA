use [2024_Maiseyeu]
/* Контроль доставки товаров. Организация продает мебель.
Информационные поля:
Наименование заказчика, Адрес, 
Телефон, Контактное лицо, Наименование товара, Цена, Описание, 
Количество заказанного товара, Дата поставки, Вид доставки.
*/

/*создаем таблицу регион*/
CREATE TABLE REGION(
ID INT PRIMARY KEY NOT NULL,
REG_NAME VARCHAR(20),
DISTRICT VARCHAR(20),
CITY VARCHAR(20));

/*DROP TABLE REGION;*/

/*создаем таблицу СПОСОБ ПОГРУЗКИ*/
CREATE TABLE LOADING(
ID INT PRIMARY KEY NOT NULL,
LOADING_NAME VARCHAR(20));

/*создаем таблицу СПОСОБ ДОСТАВКИ*/
CREATE TABLE KIND_DELIVERY(
ID INT PRIMARY KEY NOT NULL,
KINDDEL_NAME VARCHAR(20));

/*создаем таблицу ВИД ДОСТАВКИ*/
CREATE TABLE TYPE_DELIVERY(
ID INT PRIMARY KEY NOT NULL,
TYPEDEL_NAME VARCHAR(20));

/*создаем таблицу ВОДИТЕЛЬ*/
CREATE TABLE DRIVER(
ID INT PRIMARY KEY NOT NULL,
FIRSTNAME VARCHAR(20),
SURNAME VARCHAR(20),
LASTNAME VARCHAR(20)
);

/*создаем таблицу ТРАНСПОРТ*/
CREATE TABLE TRANSPORT(
ID INT PRIMARY KEY NOT NULL,
TRANSP_NAME VARCHAR(20)
);

/*создаем таблицу ПРИЧИНЫ*/
CREATE TABLE REASONS(
ID INT PRIMARY KEY NOT NULL,
REASONS_NAME VARCHAR(20)
);

/*создаем таблицу ТОВАР*/
CREATE TABLE GOODS(
ID INT PRIMARY KEY NOT NULL,
GOOD_NAME VARCHAR(60),
GOOD_ALIAS VARCHAR(20),
GOOD_DESCRIPTION VARCHAR(200),
PRICECOST MONEY,
GOOD_WEIGHT DECIMAL(7,3)
);

/*создаем таблицу ЗАКАЗЧИК*/
CREATE TABLE CUSTOMER(
ID INT PRIMARY KEY NOT NULL,
FIRSTNAME VARCHAR(20),
SURNAME VARCHAR(20),
LASTNAME VARCHAR(20),
STREET VARCHAR(60),
HOUSENUMB INT,
HOUSEPART INT,
FFLOOR INT,
FLAT INT,
PHONE VARCHAR(20),
PRICECOST MONEY,
GOOD_WEIGHT DECIMAL(7,3),
REGIONID INT,
CONSTRAINT FK_REGION_CUSTOMER FOREIGN KEY (REGIONID) REFERENCES REGION(ID)
);

/*создаем таблицу ЗАКАЗ*/
CREATE TABLE ORDERS(
ID INT PRIMARY KEY NOT NULL,
NUMBER INT,
ORDERDATE DATE,
CUSTOMER_ID INT,
LOADING_ID INT,
KIND_DEL_ID INT,
TYPE_DEL_ID INT,
DRIVER_ID INT,
TRANSPORT_ID INT,
CONSTRAINT FK_CUSTOMER_ORDERS FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER(ID),
CONSTRAINT FK_LOADING_ORDERS FOREIGN KEY (LOADING_ID) REFERENCES LOADING(ID),
CONSTRAINT FK_KINDDELIVERY_ORDERS FOREIGN KEY (KIND_DEL_ID) REFERENCES KIND_DELIVERY(ID),
CONSTRAINT FK_TYPEDELIVERY_ORDERS FOREIGN KEY (TYPE_DEL_ID) REFERENCES TYPE_DELIVERY(ID),
CONSTRAINT FK_DRIVER_ORDERS FOREIGN KEY (DRIVER_ID) REFERENCES DRIVER(ID),
CONSTRAINT FK_TRANSPORT_ORDERS FOREIGN KEY (TRANSPORT_ID) REFERENCES TRANSPORT(ID)
);

/*создаем таблицу ПОЗИЦИЙ ЗАКАЗА*/
CREATE TABLE ORDERSLINE(
ID INT PRIMARY KEY NOT NULL,
MASTERKEY INT,
GOOD_ID INT,
QUANTITY INT,
FACT_COST MONEY,
CONSTRAINT FK_ORDERS_ORDERSLINE FOREIGN KEY (MASTERKEY) REFERENCES ORDERS(ID),
CONSTRAINT FK_GOODS_ORDERSLINE FOREIGN KEY (GOOD_ID) REFERENCES GOODS(ID)
);

/*создаем таблицу РУЗУЛЬТАТ ДОСТАВКИ*/
CREATE TABLE DELIVERY_RESULT(
ID INT PRIMARY KEY NOT NULL,
ORDERSLINE_ID INT,
ISDELIVERED TINYINT DEFAULT 0,
TYPEDEL_NAME VARCHAR(20),
NODELIVERYREASONS INT,
CONSTRAINT FK_DELIVERY_RESULT_ORDERSLINE FOREIGN KEY(ORDERSLINE_ID) REFERENCES ORDERSLINE(ID),
CONSTRAINT FK_DELIVERY_RESULT_REASONS FOREIGN KEY(NODELIVERYREASONS) REFERENCES REASONS(ID));


/*ЗАПОЛНИМ ТАБЛИЦУ ПРИЧИН */
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(1,'Брак');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(2,'Перепутан товар');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(3,'Нет никого дома');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(4,'Не соответствует');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(5,'Отказ по др.причине');


/*ЗАПОЛНИМ ТАБЛИЦУ ПРИЧИН */
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(1,'Брак');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(2,'Перепутан товар');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(3,'Нет никого дома');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(4,'Не соответствует');
INSERT INTO REASONS(ID,REASONS_NAME) VALUES(5,'Отказ по др.причине');

/*ЗАПОЛНИМ ТАБЛИЦУ ВОДИТЕЛЕЙ*/
INSERT INTO DRIVER(ID,FIRSTNAME,SURNAME,LASTNAME)VALUES(101, 'Игорь','Иванов','Вячеславович');
INSERT INTO DRIVER(ID,FIRSTNAME,SURNAME,LASTNAME)VALUES(102, 'Анатолий','','Степанович');
INSERT INTO DRIVER(ID,FIRSTNAME,SURNAME,LASTNAME)VALUES(103, 'Иван','Кузьков','Алексеевич');
INSERT INTO DRIVER(ID,FIRSTNAME,SURNAME,LASTNAME)VALUES(104, 'Павел','Светлов','Максимович');
INSERT INTO DRIVER(ID,FIRSTNAME,SURNAME,LASTNAME)VALUES(105, 'Марк','Цукерберг','');
);

/*ЗАПОЛНИМ ТАБЛИЦУ ТРАНСПОРТА*/
INSERT INTO TRANSPORT(ID, TRANSP_NAME)VALUES(11011,'MAN 323 A7765-AT7');
INSERT INTO TRANSPORT(ID, TRANSP_NAME)VALUES(13012,'VOLVO E5132-IT7');
INSERT INTO TRANSPORT(ID, TRANSP_NAME)VALUES(14002,'GAZ T9287-IT5');

/*ЗАПОЛНИМ ТАБЛИЦУ СПОСОБ ПОГРУЗКИ*/
INSERT INTO LOADING(ID, LOADING_NAME) VALUES(41,'Ручная погрузка');
INSERT INTO LOADING(ID, LOADING_NAME) VALUES(42,'Механическая');
INSERT INTO LOADING(ID, LOADING_NAME) VALUES(43,'Сторонними услугами');

/*ЗАПОЛНИМ таблицу СПОСОБ ДОСТАВКИ*/
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1001,'Самовывоз клиентом');
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1002,'Автомобилем компании');
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1003,'Сторонний перевозчик');
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1004,'Яндекс доставка');
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1005,'Почтой');
INSERT INTO KIND_DELIVERY(ID,KINDDEL_NAME)VALUES(1006,'Транспортная комп-я');

/*ЗАПОЛНИМ таблицу ВИД ДОСТАВКИ*/
INSERT INTO TYPE_DELIVERY(ID,TYPEDEL_NAME)VALUES(31,'Лековой автомобиль');
INSERT INTO TYPE_DELIVERY(ID,TYPEDEL_NAME)VALUES(32,'Грузовой автомобиль');
INSERT INTO TYPE_DELIVERY(ID,TYPEDEL_NAME)VALUES(33,'Прочее');

/*ЗАПОЛНИМ таблицу РЕГИОН-ОБЛ/ГОРОД/РАЙОН*/
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10001,'Минск','','Заводской');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10002,'Минск','','Фрунзенский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10003,'Минск','','Партизанский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10004,'Минск','','Ленинский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10005,'Минск','','Центральный');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10006,'Минск','','Московский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10007,'Минск','','Октябрьский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10008,'Минск','','Советский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(10009,'Минск','','Первомайский');

INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(20001,'Привольный','Минский','');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30002,'Дзержинск','Минская','');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30003,'Фаниполь','Минская','');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30004,'Станьково','Минская','Дзержинский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30005,'Заславль','Минская','Минский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30006,'Слуцк','Минская','');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(40001,'Рогачев','Гомельская','');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(50001,'Мир','Гродненская','Кореличский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(30009,'Новосёлки','Минская','Пуховичский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(60001,'Новосёлки','Бресткая','Березовский');
INSERT INTO REGION(ID,CITY,DISTRICT,REG_NAME)VALUES(60002,'Новосёлки','Бресткая','Кобринский');

/*случайно задублировал одно название - обновлю
UPDATE REGION SET CITY='Село' where id=20002;*/ 

/*табліца товаров*/
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(1,'Диван Николетти Люкс','6345-93',87,'Угловой',1175.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(2,'Диван Серджио Люкс','12331-13',89,'Угловой',1475.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
        VALUES(3,'Диван Николетти Люкс 2700','2331-13',89,'Угловой',1247.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(4,'Диван Релоти Голд','23111-10',84,'Диван-кровать',1055.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(5,'Диван Мадрид','2241-44',81,'Диван-кровать',795.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(6,'Кровать Империя-Голд','092291',81,'Кровать',699.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(7,'Кровать Монако','093392',77,'Кровать',549.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(8,'Кровать Кельн','129111',80,'Кровать',629.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(9,'Кровать Венеция Голд','329112',80,'Кровать',959.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(10,'Кровать Рио','2349112',80,'Кровать',329.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(11,'Кресло Самурай','332123',23,'Кресло компьютерное',649.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(12,'Кресло Diplomat','3321-3',23,'Кресло компьютерное',359.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(13,'Кресло Gamer-1','32211-3',22,'Кресло компьютерное',529.00);
INSERT INTO GOODS(ID,GOOD_NAME,GOOD_ALIAS,GOOD_WEIGHT,GOOD_DESCRIPTION,PRICECOST) 
		VALUES(14,'Кресло Fusion','1100-30',22,'Кресло компьютерное',397.00);

/*Заполняем таблицу заказчиков*/
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(101,'Василий','Пупкин','Иванович',10001,'Жилуновича',23,NULL,76,3,'37544-990-10-10');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(102,'Иван','Курочкин','Семенович',10006,'Коржа',11,NULL,189,9,'37544-110-10-10');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(103,'Светлана','Добрая','Олеговна',10006,'Коржа',1,NULL,14,3,'37544-199-11-02');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(104,'Юрий','Ночной','',30003,'Советская',14,NULL,null,null,'37529-190-99-02');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(105,'Анна','Павлова','',30009,'Советская',61,NULL,null,null,'37529-223-23-12');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(106,'Наталья','Гапеева','Николаевна',40001,'Боагтырева',168,NULL,78,null,'37533-191-23-32');
INSERT INTO CUSTOMER(ID,FIRSTNAME,SURNAME,LASTNAME,REGIONID,STREET,HOUSENUMB,HOUSEPART,FLAT, FFLOOR,PHONE)
		VALUES(107,'Сергей','Волков','Валерьевич',40001,'Ленина',38,2,21,5,'37533-191-23-32');

/*ТАБЛИЦА ЗАКАЗОВ*/
INSERT INTO ORDERS(ID,NUMBER,ORDERDATE,CUSTOMER_ID,DRIVER_ID,TRANSPORT_ID,TYPE_DEL_ID,LOADING_ID,KIND_DEL_ID)
		VALUES(1,101,'2024-09-13',107,103,14002,32,41,1002);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(10,1,3,1,1475.00);    
    INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(11,1,14,1,300.00);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(12,1,8,1,629.00);

INSERT INTO ORDERS(ID,NUMBER,ORDERDATE,CUSTOMER_ID,DRIVER_ID,TRANSPORT_ID,TYPE_DEL_ID,LOADING_ID,KIND_DEL_ID)
		VALUES(2,102,'2024-09-01',106,103,14002,32,41,1002);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(100,2,3,2,1475.00);    
    INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(101,2,14,3,321.00);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(103,2,8,1,629.00);

INSERT INTO ORDERS(ID,NUMBER,ORDERDATE,CUSTOMER_ID,DRIVER_ID,TRANSPORT_ID,TYPE_DEL_ID,LOADING_ID,KIND_DEL_ID)
		VALUES(3,103,'2024-07-11',103,101,11011,32,41,1002);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(104,3,1,1,1175.00);   

INSERT INTO ORDERS(ID,NUMBER,ORDERDATE,CUSTOMER_ID,DRIVER_ID,TRANSPORT_ID,TYPE_DEL_ID,LOADING_ID,KIND_DEL_ID)
		VALUES(4,103,'2024-10-01',101,102,11011,32,41,1002);
	INSERT INTO ORDERSLINE(ID,MASTERKEY,GOOD_ID,QUANTITY,FACT_COST)
		VALUES(105,4,5,2,1175.00); 

/*добавим статусы*/
INSERT INTO DELIVERY_RESULT(ID, ORDERSLINE_ID, ISDELIVERED,TYPEDEL_NAME,NODELIVERYREASONS)
   VALUES(1,104,0,'',1);
INSERT INTO DELIVERY_RESULT(ID, ORDERSLINE_ID, ISDELIVERED,TYPEDEL_NAME,NODELIVERYREASONS)
   VALUES(2,103,1,'',NULL);
INSERT INTO DELIVERY_RESULT(ID, ORDERSLINE_ID, ISDELIVERED,TYPEDEL_NAME,NODELIVERYREASONS)
   VALUES(3,105,1,'',NULL);
INSERT INTO DELIVERY_RESULT(ID, ORDERSLINE_ID, ISDELIVERED,TYPEDEL_NAME,NODELIVERYREASONS)
   VALUES(4,100,1,'',NULL);
INSERT INTO DELIVERY_RESULT(ID, ORDERSLINE_ID, ISDELIVERED,TYPEDEL_NAME,NODELIVERYREASONS)
   VALUES(5,101,1,'',NULL);

/**/

/*========== ЗАПРОСЫ К МОЕЙ БД ===========*/

/*ГЛЯНЕМ ЗАКАЗЫ, В КОТОРЫХ ЕСТЬ ОДНА ИЛИ НЕСКОЛЬКО ПОЗИЦИЙ НЕ ДОСТАЛВНО*/
--0,0156946 
SELECT  
  O.NUMBER, O.ORDERDATE, G.GOOD_NAME 
FROM ORDERS O
LEFT JOIN ORDERSLINE OL ON OL.MASTERKEY = O.ID
LEFT JOIN GOODS G ON G.ID = OL.GOOD_ID
WHERE OL.ID IN (SELECT ORDERSLINE_ID FROM DELIVERY_RESULT WHERE ISDELIVERED=0)

/*УЗНАЕМ ПРИЧИНЫ ПО КОТОРЫМ ТОВАРЫ НЕ ДОСТАВЛЕНЫ И ЧТО ЭТО ЗА ТОВАР*/
--0,0131517
SELECT 
  G.GOOD_NAME, 
  OL.QUANTITY, 
  OL.FACT_COST,
  REASONS_NAME 
FROM DELIVERY_RESULT DR
JOIN ORDERSLINE OL ON OL.ID = DR.ORDERSLINE_ID
JOIN GOODS G ON G.ID = OL.GOOD_ID
JOIN REASONS R ON R.ID = DR.NODELIVERYREASONS
WHERE DR.ISDELIVERED = 0


/* ОПРЕДЕЛИМ РЕГИОНЫ ПО УБЫВАНИЮ ПОКУПАТЕЛЬСКОЙ СПОСОБНОСТИ*/
--0,0385281
SELECT 
  R.CITY, 
  SUM(OL.QUANTITY*OL.FACT_COST) AMOUNT
FROM ORDERS O
JOIN ORDERSLINE OL ON OL.MASTERKEY = O.ID
JOIN CUSTOMER C ON C.ID = O.CUSTOMER_ID
JOIN REGION R ON R.ID = C.REGIONID
GROUP BY R.CITY 
ORDER BY 2 DESC

/*ВНЕСЕМ ДАННЫЕ ПРЕДЫДУЩЕГО ЗАПРОСА ВО ВРЕМЕННУЮ ЛОКАЛЬНУЮ ТАБЛИЦУ*/
SELECT 
  R.CITY, 
  SUM(OL.QUANTITY*OL.FACT_COST) AMOUNT
INTO #RELEVANTREGION
FROM ORDERS O
JOIN ORDERSLINE OL ON OL.MASTERKEY = O.ID
JOIN CUSTOMER C ON C.ID = O.CUSTOMER_ID
JOIN REGION R ON R.ID = C.REGIONID
GROUP BY R.CITY 
ORDER BY 2 DESC

/*ГЛЯНЕМ ЧТО ПОЛУЧІЛОСЬ*/
SELECT * FROM #RELEVANTREGION

/*ОПРЕДЕЛИМ ПРОЦЕНТНОЕ СООТНОШЕНИЕ КАЖДОГО РЕГИОНА ОТ ВСЕХ ПРОДАЖ*/
SELECT 
  R.CITY,
  R.AMOUNT,
  R.AMOUNT/(SELECT 
           SUM(AMOUNT) 
		   FROM #RELEVANTREGION)*100 AS PERC
FROM #RELEVANTREGION R

/*ГЛЯНЕМ ПРОДАЖИ СО СКИДКОЙ/НАЦЕНКОЙ */
--0,0082109
SELECT 
G.GOOD_NAME, G.PRICECOST, OL.FACT_COST,
IIF(G.PRICECOST<OL.FACT_COST, OL.FACT_COST-G.PRICECOST,0) AS BONUS,
IIF(G.PRICECOST>OL.FACT_COST, ABS(OL.FACT_COST-G.PRICECOST),0) AS DISC
FROM ORDERSLINE OL
JOIN GOODS G ON G.ID = OL.GOOD_ID
WHERE OL.FACT_COST<>G.PRICECOST


